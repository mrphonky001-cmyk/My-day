<!DOCTYPE html>
<html lang="en" data-theme="dark" data-font="medium">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Nepal Premium News Aggregator">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dark News | Ultimate Edition</title>

    <style>
        /* =========================================
           1. VARIABLES & RESET
           ========================================= */
        :root {
            /* Palette - Logic Layer */
            --primary: #E63946; /* Vibrant Red */
            --primary-dim: rgba(230, 57, 70, 0.15);
            --accent: #457B9D;
            
            /* Theme Colors (Default Dark) */
            --bg-body: #121212;
            --bg-surface: #1e1e1e;
            --bg-surface-2: #252525;
            --bg-glass: rgba(18, 18, 18, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --text-faint: #505050;

            /* Dimensions */
            --header-h: 60px;
            --nav-h: 65px;
            --max-w: 800px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            /* Animation */
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
            --spring: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* AMOLED Theme Override */
        [data-amoled="true"] {
            --bg-body: #000000;
            --bg-surface: #0a0a0a;
            --bg-surface-2: #141414;
            --bg-glass: rgba(0, 0, 0, 0.9);
            --border: #222;
        }

        /* Typography Scaling */
        [data-font="small"] { font-size: 14px; }
        [data-font="medium"] { font-size: 16px; }
        [data-font="large"] { font-size: 18px; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-h) + var(--safe-bottom) + 20px);
        }

        /* =========================================
           2. HEADER & SEARCH
           ========================================= */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: var(--bg-glass);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            padding-top: var(--safe-top);
        }

        .header-content {
            height: var(--header-h);
            max-width: var(--max-w); margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; position: relative;
        }

        .logo-area { display: flex; flex-direction: column; line-height: 1; }
        .logo { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; }
        .logo span { color: var(--primary); }
        .logo-sub { font-size: 0.65rem; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; font-weight: 600; margin-top: 2px; }

        .header-actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: none;
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .btn-icon:active { transform: scale(0.92); background: rgba(255,255,255,0.1); }

        /* Search Overlay */
        .search-bar {
            position: absolute; inset: 0; top: var(--safe-top);
            background: var(--bg-surface);
            display: flex; align-items: center; padding: 0 16px;
            transform: translateY(-120%); transition: transform 0.3s var(--ease);
            z-index: 10;
        }
        .search-bar.active { transform: translateY(0); }
        .search-input {
            flex: 1; background: transparent; border: none; color: white;
            font-size: 1.1rem; padding: 0 12px; outline: none; height: 100%;
        }

        /* Category Rail */
        .cat-rail {
            display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px;
            background: var(--bg-body); border-bottom: 1px solid var(--border);
            scrollbar-width: none; max-width: var(--max-w); margin: 0 auto;
        }
        .cat-rail::-webkit-scrollbar { display: none; }
        
        .chip {
            padding: 6px 16px; border-radius: 100px;
            background: var(--bg-surface); color: var(--text-muted);
            font-size: 0.85rem; font-weight: 600; white-space: nowrap;
            border: 1px solid var(--border); transition: 0.3s var(--ease);
            cursor: pointer;
        }
        .chip.active {
            background: var(--text-main); color: var(--bg-body);
            border-color: var(--text-main); transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
        }

        /* =========================================
           3. MAIN FEED & CARDS
           ========================================= */
        main { padding-top: calc(var(--header-h) + var(--safe-top) + 65px); min-height: 100vh; }
        .container { max-width: var(--max-w); margin: 0 auto; padding: 0 16px; }

        .news-card {
            background: var(--bg-surface); border-radius: var(--radius-md);
            overflow: hidden; margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            animation: slideUp 0.5s var(--ease) backwards;
            transition: transform 0.2s; position: relative;
        }
        .news-card:active { transform: scale(0.98); }

        .card-media {
            position: relative; width: 100%; padding-top: 56.25%; /* 16:9 */
            background: var(--bg-surface-2); overflow: hidden;
        }
        .card-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transition: opacity 0.3s;
        }
        
        .card-content { padding: 16px; }
        
        .card-meta {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;
        }
        .source-badge { 
            color: var(--primary); font-weight: 700; text-transform: uppercase; 
            letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;
        }
        .source-badge::before { content:''; width:6px; height:6px; background:currentColor; border-radius:50%; }

        .card-title {
            font-size: 1.15rem; font-weight: 700; line-height: 1.4;
            color: var(--text-main); margin-bottom: 8px;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .card-excerpt {
            font-size: 0.9rem; color: var(--text-muted); line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .card-actions {
            position: absolute; top: 10px; right: 10px; z-index: 5;
        }
        .action-fab {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.15); color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .action-fab.bookmarked { background: var(--primary); border-color: var(--primary); }

        /* Skeletons */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-surface-2) 25%, #333 50%, var(--bg-surface-2) 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
        }
        .sk-card { height: 320px; border-radius: var(--radius-md); margin-bottom: 20px; border: 1px solid var(--border); background: var(--bg-surface); }
        
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           4. MODALS (Reader, Settings)
           ========================================= */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            opacity: 0; pointer-events: none; transition: 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }

        /* Settings Panel */
        .sheet-panel {
            background: var(--bg-surface); width: 100%; max-width: 600px;
            border-radius: 24px 24px 0 0; padding: 24px;
            transform: translateY(100%); transition: transform 0.3s var(--spring);
            border-top: 1px solid var(--border);
        }
        .modal-overlay.open .sheet-panel { transform: translateY(0); }

        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .setting-label { font-size: 1rem; font-weight: 500; }
        .setting-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
        
        /* Toggle Switch */
        .toggle {
            width: 50px; height: 28px; background: var(--bg-surface-2);
            border-radius: 50px; position: relative; cursor: pointer; transition: 0.3s;
        }
        .toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 24px; height: 24px; background: white; border-radius: 50%;
            transition: 0.3s var(--spring); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle.checked { background: var(--primary); }
        .toggle.checked::after { transform: translateX(22px); }

        /* Reader View */
        .reader-view {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 3000;
            transform: translateY(100%); transition: transform 0.35s var(--ease);
            overflow-y: auto;
        }
        .reader-view.active { transform: translateY(0); }
        
        .reader-hero { height: 35vh; width: 100%; position: relative; }
        .reader-hero img { width: 100%; height: 100%; object-fit: cover; }
        .reader-hero::after {
            content:''; position: absolute; inset: 0;
            background: linear-gradient(to bottom, transparent 0%, var(--bg-body) 100%);
        }
        
        .reader-body { padding: 0 20px 100px; position: relative; margin-top: -60px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .reader-title { font-size: 1.8rem; font-weight: 800; line-height: 1.3; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .reader-text { font-size: 1.1rem; line-height: 1.8; color: #d0d0d0; }
        .reader-text p { margin-bottom: 20px; }
        
        .fab-close {
            position: fixed; top: 20px; right: 20px; z-index: 3001;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* =========================================
           5. BOTTOM NAVIGATION
           ========================================= */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px; height: var(--nav-h);
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 100px;
            display: flex; justify-content: space-evenly; align-items: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 900;
        }

        .nav-item {
            color: var(--text-muted); padding: 12px; border-radius: 50%;
            transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .nav-item svg { width: 24px; height: 24px; transition: 0.3s; }
        .nav-item.active { color: white; }
        .nav-item.active svg { transform: translateY(-3px); color: var(--primary); }
        .nav-item.active::after {
            content:''; width: 4px; height: 4px; background: var(--primary);
            border-radius: 50%; margin-top: 4px; position: absolute; bottom: 10px;
        }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 600; opacity: 0; pointer-events: none;
            transition: 0.3s; z-index: 4000; border: 1px solid var(--border);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); white-space: nowrap;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo-area">
                <div class="logo">Dark<span>News</span></div>
                <div class="logo-sub">Nepal Premium</div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="btn-search-toggle">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
                <button class="btn-icon" id="btn-settings-toggle">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
            
            <!-- Search Bar Overlay -->
            <div class="search-bar" id="search-bar">
                <svg width="20" height="20" stroke="#888" fill="none" viewBox="0 0 24 24" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" id="search-input" placeholder="Filter news topics...">
                <button class="btn-icon" id="btn-search-close">
                    <svg width="20" height="20" stroke="currentColor" fill="none" viewBox="0 0 24 24" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <!-- CATEGORY RAIL -->
        <nav class="cat-rail" id="cat-rail"></nav>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container">
        <div id="feed-grid"></div>
        <div id="load-msg" style="text-align:center; padding:30px; color:var(--text-muted); display:none;">No more posts</div>
    </main>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal">
        <div class="sheet-panel">
            <h2 style="margin-bottom:20px;">Preferences</h2>
            
            <div class="setting-item">
                <div>
                    <div class="setting-label">AMOLED Mode</div>
                    <div class="setting-sub">Pitch black background</div>
                </div>
                <div class="toggle" id="opt-amoled"></div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Data Saver</div>
                    <div class="setting-sub">Hide images to save bandwidth</div>
                </div>
                <div class="toggle" id="opt-saver"></div>
            </div>

            <div class="setting-item" style="display:block;">
                <div class="setting-label" style="margin-bottom:10px;">Font Size</div>
                <input type="range" min="1" max="3" value="2" id="opt-font" style="width:100%; accent-color:var(--primary);">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                    <span>Small</span><span>Medium</span><span>Large</span>
                </div>
            </div>

            <button id="btn-clear-cache" style="width:100%; margin-top:25px; padding:15px; background:var(--bg-surface-2); color: #ff4757; border:none; border-radius:12px; font-weight:600;">Clear History & Cache</button>
        </div>
    </div>

    <!-- READER VIEW -->
    <div class="reader-view" id="reader-view">
        <button class="fab-close" id="btn-reader-close">
            <svg width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="reader-hero">
            <img id="r-img" src="" alt="">
        </div>
        <div class="reader-body">
            <div class="card-meta" style="margin:20px 0;">
                <span class="source-badge" id="r-source">Source</span>
                <span id="r-date">Date</span>
            </div>
            <h1 class="reader-title" id="r-title">Title</h1>
            <div class="reader-text" id="r-text"></div>
            <a href="#" id="r-link" target="_blank" style="display:block; text-align:center; margin-top:40px; padding:14px; background:var(--primary); color:white; text-decoration:none; border-radius:50px; font-weight:600;">Visit Original Website</a>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-view="home">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </div>
        <div class="nav-item" data-view="bookmarks">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
        </div>
        <div class="nav-item" data-view="history">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        </div>
    </nav>

    <!-- TOAST -->
    <div class="toast" id="toast">Notification</div>

    <script>
        /**
         * DARK NEWS HYBRID ENGINE v4.0
         * Integrates RSS Proxy + WorldNewsAPI with State Persistence
         */
        const CONFIG = {
            API_KEY: '6739e08133d44863adfe986ee092e62b', // WorldNewsAPI
            RSS_PROXY: 'https://api.rss2json.com/v1/api.json?rss_url=',
            PLACEHOLDER: 'https://images.unsplash.com/photo-1585829365295-ab7cd400c167?w=800&q=80',
            SOURCES: [
                {
                    id: 'nepal', name: 'Nepal', type: 'rss',
                    feeds: [
                        'https://english.onlinekhabar.com/feed',
                        'https://thehimalayantimes.com/feed'
                    ]
                },
                {
                    id: 'global', name: 'Global', type: 'api',
                    query: '&source-countries=us,gb&language=en'
                },
                {
                    id: 'tech', name: 'Tech', type: 'rss',
                    feeds: ['https://techlekh.com/feed', 'https://www.theverge.com/rss/index.xml']
                },
                {
                    id: 'biz', name: 'Business', type: 'rss',
                    feeds: ['https://thehimalayantimes.com/category/business/feed']
                },
                {
                    id: 'sports', name: 'Sports', type: 'rss',
                    feeds: ['https://english.onlinekhabar.com/category/sports/feed']
                }
            ]
        };

        // --- STATE MANAGEMENT ---
        const Store = {
            state: {
                view: 'home',
                category: 'nepal',
                articles: [],
                bookmarks: JSON.parse(localStorage.getItem('dn_bookmarks')) || [],
                history: JSON.parse(localStorage.getItem('dn_history')) || [],
                settings: JSON.parse(localStorage.getItem('dn_settings')) || { amoled: false, saver: false, font: 2 }
            },
            save(key) { localStorage.setItem(`dn_${key}`, JSON.stringify(this.state[key])); },
            updateSetting(key, val) { 
                this.state.settings[key] = val; 
                this.save('settings'); 
                UI.applyTheme(); 
            }
        };

        // --- APP CONTROLLER ---
        let fetchController = null;

        const App = {
            init() {
                UI.init();
                UI.applyTheme();
                this.loadCategory('nepal');
            },

            async loadCategory(catId) {
                // Abort previous requests if switching quickly
                if (fetchController) fetchController.abort();
                fetchController = new AbortController();
                const signal = fetchController.signal;

                Store.state.category = catId;
                UI.updateRail(catId);
                UI.renderSkeleton();
                Store.state.articles = [];

                try {
                    const source = CONFIG.SOURCES.find(s => s.id === catId);
                    let rawData = [];

                    if (source.type === 'api') {
                        // API Fetch
                        const url = `https://api.worldnewsapi.com/search-news?api-key=${CONFIG.API_KEY}${source.query}&number=20`;
                        const res = await fetch(url, { signal });
                        const data = await res.json();
                        if (data.news) rawData = data.news.map(item => this.normalize(item, 'api'));
                    } else {
                        // Parallel RSS Fetch
                        const promises = source.feeds.map(url => 
                            fetch(CONFIG.RSS_PROXY + encodeURIComponent(url), { signal })
                            .then(r => r.json()).catch(() => null)
                        );
                        const results = await Promise.all(promises);
                        results.forEach(res => {
                            if (res && res.items) {
                                rawData.push(...res.items.map(item => this.normalize(item, 'rss', res.feed.title)));
                            }
                        });
                    }

                    if (!signal.aborted) {
                        // Deduplicate & Sort
                        const seen = new Set();
                        Store.state.articles = rawData
                            .filter(i => { const d = !seen.has(i.link); seen.add(i.link); return d; })
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        UI.renderFeed(Store.state.articles);
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') UI.renderError();
                }
            },

            normalize(item, type, sourceName) {
                let img = null;
                // Complex Image Extraction for RSS
                if (type === 'rss') {
                    if (item.enclosure && item.enclosure.link) img = item.enclosure.link;
                    else if (item.thumbnail) img = item.thumbnail;
                    else {
                        const match = (item.description || item.content || '').match(/src="([^"]+)"/);
                        if (match) img = match[1];
                    }
                } else {
                    img = item.image;
                }

                // Data Saver Check
                if (Store.state.settings.saver) img = null;
                if (!img && !Store.state.settings.saver) img = CONFIG.PLACEHOLDER;

                return {
                    title: item.title,
                    link: type === 'api' ? item.url : item.link,
                    source: type === 'api' ? (item.author || 'WorldNews') : sourceName,
                    date: item.pubDate || item.publish_date,
                    desc: this.stripHtml(item.description || item.text || item.content || ''),
                    image: img,
                    content: item.content || item.text // Full content for reader
                };
            },

            toggleBookmark(link) {
                const list = Store.state.bookmarks;
                const idx = list.findIndex(b => b.link === link);
                
                if (idx > -1) {
                    list.splice(idx, 1);
                    UI.showToast('Bookmark Removed');
                } else {
                    // Find article in current feed or history
                    const pool = [...Store.state.articles, ...Store.state.history];
                    const article = pool.find(a => a.link === link);
                    if (article) {
                        list.unshift(article);
                        UI.showToast('Bookmarked');
                    }
                }
                Store.save('bookmarks');
                UI.updateBookmarkIcons();
                if (Store.state.view === 'bookmarks') UI.renderFeed(list);
            },

            addToHistory(article) {
                const list = Store.state.history;
                if (!list.find(h => h.link === article.link)) {
                    list.unshift(article);
                    if (list.length > 50) list.pop();
                    Store.save('history');
                }
            },

            stripHtml(html) {
                const tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return (tmp.textContent || tmp.innerText || "").substring(0, 150) + "...";
            },

            timeAgo(date) {
                const diff = (new Date() - new Date(date)) / 1000;
                if (diff < 3600) return Math.floor(diff/60) + 'm ago';
                if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
                return Math.floor(diff/86400) + 'd ago';
            }
        };

        // --- UI RENDERER ---
        const UI = {
            els: {
                rail: document.getElementById('cat-rail'),
                grid: document.getElementById('feed-grid'),
                reader: document.getElementById('reader-view'),
                settings: document.getElementById('settings-modal'),
                searchBar: document.getElementById('search-bar'),
                searchInput: document.getElementById('search-input')
            },

            init() {
                // Render Categories
                this.els.rail.innerHTML = CONFIG.SOURCES.map(s => 
                    `<div class="chip" data-id="${s.id}">${s.name}</div>`
                ).join('');
                
                // Event Listeners
                this.els.rail.addEventListener('click', e => {
                    if(e.target.classList.contains('chip')) App.loadCategory(e.target.dataset.id);
                });

                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const view = btn.dataset.view;
                        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        Store.state.view = view;
                        this.handleViewChange(view);
                    });
                });

                // Modals
                document.getElementById('btn-settings-toggle').onclick = () => this.els.settings.classList.add('open');
                this.els.settings.onclick = (e) => { if(e.target === this.els.settings) this.els.settings.classList.remove('open'); };
                document.getElementById('btn-reader-close').onclick = () => this.els.reader.classList.remove('active');

                // Search
                document.getElementById('btn-search-toggle').onclick = () => {
                    this.els.searchBar.classList.add('active');
                    this.els.searchInput.focus();
                };
                document.getElementById('btn-search-close').onclick = () => {
                    this.els.searchBar.classList.remove('active');
                    this.els.searchInput.value = '';
                    this.renderFeed(Store.state.articles); // Reset filter
                };
                this.els.searchInput.addEventListener('keyup', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = Store.state.articles.filter(a => a.title.toLowerCase().includes(term));
                    this.renderFeed(filtered);
                });

                // Settings Toggles
                document.getElementById('opt-amoled').onclick = () => App.Store.updateSetting('amoled', !Store.state.settings.amoled);
                document.getElementById('opt-saver').onclick = () => App.Store.updateSetting('saver', !Store.state.settings.saver);
                document.getElementById('opt-font').oninput = (e) => App.Store.updateSetting('font', e.target.value);
                document.getElementById('btn-clear-cache').onclick = () => {
                    localStorage.clear(); location.reload();
                };
            },

            handleViewChange(view) {
                window.scrollTo(0,0);
                this.els.rail.style.display = view === 'home' ? 'flex' : 'none';
                this.els.searchBar.classList.remove('active');
                
                if (view === 'home') {
                    if (Store.state.articles.length) this.renderFeed(Store.state.articles);
                    else App.loadCategory(Store.state.category);
                } else {
                    const data = view === 'bookmarks' ? Store.state.bookmarks : Store.state.history;
                    this.renderFeed(data, view === 'bookmarks' ? "No bookmarks yet" : "No reading history");
                }
            },

            renderSkeleton() {
                this.els.grid.innerHTML = Array(3).fill('<div class="sk-card skeleton"></div>').join('');
            },

            renderFeed(articles, emptyMsg = "No news found") {
                if (!articles.length) {
                    this.els.grid.innerHTML = `<div style="text-align:center; padding:50px; color:var(--text-muted)">${emptyMsg}</div>`;
                    return;
                }

                this.els.grid.innerHTML = articles.map((article, i) => {
                    const isBm = Store.state.bookmarks.some(b => b.link === article.link);
                    return `
                    <article class="news-card" style="animation-delay:${i*0.05}s">
                        ${article.image ? `
                        <div class="card-media" onclick="UI.openReader('${article.link}')">
                            <img src="${article.image}" class="card-img" loading="lazy" onerror="this.src='${CONFIG.PLACEHOLDER}'">
                        </div>` : ''}
                        
                        <div class="card-actions">
                            <button class="action-fab ${isBm?'bookmarked':''}" onclick="App.toggleBookmark('${article.link}')">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="${isBm?'white':'none'}" stroke="white" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                            </button>
                        </div>

                        <div class="card-content" onclick="UI.openReader('${article.link}')">
                            <div class="card-meta">
                                <span class="source-badge">${article.source}</span>
                                <span>${App.timeAgo(article.date)}</span>
                            </div>
                            <h3 class="card-title">${article.title}</h3>
                            <p class="card-excerpt">${article.desc}</p>
                        </div>
                    </article>
                `}).join('');
            },

            openReader(link) {
                const pool = [...Store.state.articles, ...Store.state.bookmarks, ...Store.state.history];
                const item = pool.find(a => a.link === link);
                if (!item) return;

                App.addToHistory(item);
                
                document.getElementById('r-img').src = item.image || CONFIG.PLACEHOLDER;
                document.getElementById('r-img').style.display = Store.state.settings.saver ? 'none' : 'block';
                document.getElementById('r-source').innerText = item.source;
                document.getElementById('r-date').innerText = new Date(item.date).toDateString();
                document.getElementById('r-title').innerText = item.title;
                document.getElementById('r-text').innerHTML = item.content || `<p>${item.desc}</p>`;
                document.getElementById('r-link').href = item.link;

                this.els.reader.classList.add('active');
            },

            renderError() {
                this.els.grid.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted)">Connection Failed.<br>Tap category to retry.</div>`;
            },

            updateRail(id) {
                document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.id === id));
            },

            updateBookmarkIcons() {
                if (Store.state.view !== 'home') return; // Simple redraw if in home
                this.renderFeed(Store.state.articles); 
            },

            applyTheme() {
                const s = Store.state.settings;
                document.documentElement.setAttribute('data-amoled', s.amoled);
                document.documentElement.setAttribute('data-font', s.font == 1 ? 'small' : s.font == 3 ? 'large' : 'medium');
                
                document.getElementById('opt-amoled').classList.toggle('checked', s.amoled);
                document.getElementById('opt-saver').classList.toggle('checked', s.saver);
                document.getElementById('opt-font').value = s.font;
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('visible');
                setTimeout(() => t.classList.remove('visible'), 2000);
            }
        };

        App.Store = Store; // Expose for internal access
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>